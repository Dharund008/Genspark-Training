# FirstAPI Project – Working Flow & Architecture

This document explains the **end-to-end flow** of your ASP.NET Core API project (`FirstAPI` under `June4`), focusing on how data moves through the system, with code references and explanations for each major feature. All flows are described as they happen when using **Swagger**.

---

## 1. Code-Level Trace: Authentication & Authorization Filters

### Authentication Filter
```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateAudience = false,
            ValidateIssuer = false,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration["Keys:JwtTokenKey"]))
        };
    });
```
- Registers JWT Bearer authentication.
- Validates JWT tokens for `[Authorize]` endpoints.
- If missing: No authentication, all endpoints are open, and `[Authorize]` is ignored.

### Authorization Filter
```csharp
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("ExperiencedDoctorOnly", policy =>
        policy.RequireRole("Doctor")
              .Requirements.Add(new MinimumExperienceRequirement(3)));
});
builder.Services.AddScoped<IAuthorizationHandler, ExperienceHandler>();
```
- Registers custom policies (e.g., `"ExperiencedDoctorOnly"`).
- Uses `ExperienceHandler` to check doctor experience.
- If missing: Policy-protected endpoints always return 403 Forbidden.


### Swagger Security Injection
```csharp
builder.Services.AddSwaggerGen(opt =>
{
    opt.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        In = ParameterLocation.Header,
        Description = "Please enter token",
        Name = "Authorization",
        Type = SecuritySchemeType.Http,
        BearerFormat = "JWT",
        Scheme = "bearer"
    });
    opt.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type=ReferenceType.SecurityScheme,
                    Id="Bearer"
                }
            },
            new string[]{}
        }
    });
});
```
- Enables JWT token input and testing in Swagger UI.
- If missing: Cannot test `[Authorize]` endpoints in Swagger.

---

## **Summary : 
- Without authentication/authorization filters, your security is broken or non-existent.
- Without Swagger security config, you can’t test protected endpoints from Swagger.

---

## 2. log4net Logging Framework

### Content (Configuration)
The log4net configuration is defined in the `log4net.config` file located in the `June4/FirstAPI` directory. It sets up a root logger with the logging level set to "ALL" to capture all log messages. The configuration uses a FileAppender named "RollingFile" that writes log entries to a file called `main.log`. The log messages are formatted to include the date, thread ID, log level, logger name, and the message content.

**Example snippet from log4net.config:**
```xml
<log4net>
  <root>
    <level value="ALL" />
    <appender-ref ref="RollingFile" />
  </root>

  <appender name="RollingFile" type="log4net.Appender.FileAppender">
    <file value="main.log" />
    <layout type="log4net.Layout.PatternLayout">
      <conversionPattern value="%date [%thread] %level %logger - %message%newline" />
    </layout>
  </appender>
</log4net>
```

### Flow of Using log4net

1. **Configuration Loading:**  
   During application startup, the `log4net.config` file is loaded automatically by the logging provider.

2. **Initialization:**  
   In `Program.cs`, log4net is added to the ASP.NET Core logging pipeline with the line:
   ```csharp
   builder.Logging.AddLog4Net();
   ```

3. **Logging Usage:**  
   Throughout the application, components use the ASP.NET Core logging abstractions (e.g., `ILogger<T>`) to log messages. These messages are routed to log4net.

4. **Log Writing:**  
   log4net writes the log messages to the `main.log` file as per the configuration.

### Purpose of log4net

- To provide a robust, flexible, and configurable logging framework.
- To capture detailed logs for diagnostics, monitoring, and troubleshooting.
- To persist logs in a file (`main.log`) with a customizable format for easy analysis.

### Where Logs Are Visible

The logs generated by log4net are written to the `main.log` file located in the root directory of the running application (`June4/FirstAPI`). This file contains all log entries formatted with timestamps, thread information, log levels, and messages.

### How to See Logs

- Run the application normally (e.g., using `dotnet run` inside the `June4/FirstAPI` directory).
- As the application runs, log4net writes log entries to the `main.log` file.
- Open or tail the `main.log` file to monitor the logs in real-time or review past logs.

---

## **Summary**
- Without authentication/authorization filters, your security is broken or non-existent.
- Without Swagger security config, you can’t test protected endpoints from Swagger.
- With log4net, you have robust, file-based logging for diagnostics and monitoring.

---

## **Summary Table**

| Layer         | Example File/Type                | Responsibility                              |
|---------------|----------------------------------|---------------------------------------------|
| Controller    | `DoctorController.cs`            | Handles HTTP requests/responses             |
| Service       | `AppointmentService.cs`          | Business logic, validation                  |
| Repository    | `IRepository<T>`                 | Data access (CRUD)                          |
| Context       | `ClinicContext.cs`               | Database context (EF Core)                  |
| DTO           | `AppointmentRequestDTO.cs`       | Data transfer between client and server     |
| Mapper        | `AutoMapperProfile.cs`           | Object-object mapping                       |
| Auth Service  | `AuthenticationService.cs`       | Login, password check, token generation     |
| Encryption    | `EncryptionService.cs`           | Password hashing                            |
| Token         | `TokenService.cs`                | JWT creation                                |
| Authorization | `ExperienceHandler.cs`           | Custom policy for doctor experience         |
| Program       | `Program.cs`                     | App configuration, DI, middleware           |

---

## **Typical Request Flow Example (Add Appointment)**

1. **Swagger**: User submits appointment request.
2. **Controller**: Receives and validates request.
3. **AppointmentService**: Handles business logic (patient/doctor lookup, password check, slot check).
4. **Repository**: Adds appointment to database.
5. **DbContext**: Saves changes.
6. **Controller**: Returns response to Swagger.

---

## **Typical Request Flow Example (Delete Appointment)**

1. **Swagger**: Doctor sends DELETE request with JWT.
2. **Authorization Middleware**: Validates token and experience policy.
3. **Controller**: Fetches and soft-deletes appointment.
4. **Repository**: Updates appointment status.
5. **Controller**: Returns response to Swagger.

---

---